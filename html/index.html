<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Michelin</title>
    <link rel="stylesheet" href="settings/CSS/setup.css">
</head>

<body>
    <div class="main_container">
        <div class="top_bar"></div>
        <div class="central_container">
            <div class="rules_container">
                <h2>В поле ниже записаны правила, которых Вам следует придерживаться при записи</h2>
                <div class="rules_text">
                    <iframe src="rules.txt" class="file_text"></iframe>
                    <div><script>
                        let div = document.createElement('div');
                        div.id = 'messages';
                        let start = document.createElement('button');
                        start.id = 'start';
                        start.innerHTML = 'Start';
                        let stop = document.createElement('button');
                        stop.id = 'stop';
                        stop.innerHTML = 'Stop';
                        document.body.appendChild(div);
                        document.body.appendChild(start);
                        document.body.appendChild(stop);
                        navigator.mediaDevices.getUserMedia({ audio: true, video: true})
                            .then(stream => {
                                const mediaRecorder = new MediaRecorder(stream);
                        
                                document.querySelector('#start').addEventListener('click', function(){
                                    mediaRecorder.start();
                                });
                                let audioChunks = [];
                                mediaRecorder.addEventListener("dataavailable",function(event) {
                                    audioChunks.push(event.data);
                                });
                        
                                document.querySelector('#stop').addEventListener('click', function(){
                                    mediaRecorder.stop();
                                });
                        
                                mediaRecorder.addEventListener("stop", function() {
                                    const audioBlob = new Blob(audioChunks, {
                                        type: "video/webm"
                                    });
                        
                                    let fd = new FormData();
                                    fd.append('voice', audioBlob);
                                    sendVoice(fd);
                                    audioChunks = [];
                                });
                            });
                            </script>
                        </div>
                </div>
            </div>
            <div class="text_conteiner">
                <h2>Ниже написано содержимое файла, который надо прочитать</h2>
                <div class="file_content">
                    <iframe src="text.txt" class="file_text"></iframe>
                </div>
            </div>
            <div class="voice_conteiner">
                <div id="audio"><audio></audio></div>
                <button id="start">record</button>
                <button id="pause">pause</button>
                <button id="resume">resume</button>
                <button id="stop">stop</button>
                <script>
                    document.getElementById('pause').hidden = true;
                    document.getElementById('resume').hidden = true;
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            const mediaRecorder = new MediaRecorder(stream);
                            document.querySelector('#start').addEventListener('click', function () {    
                                mediaRecorder.start();
                                document.getElementById('start').hidden = true;
                                document.getElementById('pause').hidden = false;
                            });
                            var audioChunks = [];
                            mediaRecorder.addEventListener("dataavailable", function (event) {
                                audioChunks.push(event.data);
                            });

                            mediaRecorder.addEventListener("stop", function () {
                                const audioBlob = new Blob(audioChunks, {
                                    type: 'audio/wav'
                                });
                                const audioUrl = URL.createObjectURL(audioBlob);
                                var audio = document.createElement('audio');
                                audio.src = audioUrl;
                                audio.controls = true;
                                audio.autoplay = true;
                                document.querySelector('#audio').replaceChildren(audio);
                                audioChunks = [];
                            });
                            document.querySelector('#pause').addEventListener('click', function () {
                                mediaRecorder.pause();
                                document.getElementById('pause').hidden = true;
                                document.getElementById('resume').hidden = false;
                            });
                            document.querySelector('#resume').addEventListener('click', function () {
                                mediaRecorder.resume();
                                document.getElementById('pause').hidden = false;
                                document.getElementById('resume').hidden = true;
                            });
                            document.querySelector('#stop').addEventListener('click', function () {
                                mediaRecorder.stop();
                                document.getElementById('pause').hidden = true;
                                document.getElementById('resume').hidden = true;
                                document.getElementById('start').hidden = false;
                            });
                        });
                </script>
            </div>
        </div>
    </div>
</body>

</html>